var geminiNew=function(){var instanceArray=function(){var result=result||{};if(typeof geminiInstanceArray!="undefined"){result=geminiInstanceArray}if(typeof geminiMap!="undefined"){var mapEntry=geminiMap.getAll();for(var key in mapEntry){result[key]=mapEntry[key]}}return result}();var recheckCount=20;var domain=function(){if(typeof inGeminiTestEnv!="undefined"){return"net"}return"com"}();var debugMode=function(){if(typeof forceOpenDebugMode!="undefined"){return true}return false}();var geminiConstant={cacheKey:"ab_t_d_r_",cacheInfoKey:"key",forceDivideParamKey:"fDK",divideTypeNormal:"normal",divideTypeLocal:"local",divideTypeQuery:"query",divideCallbackCss:"css",divideCallbackJump:"jump",blockTypeInline:"inline",dotTypeWhole:"whole",dotTypeTestZone:"testZone",none:"none",expiredFiveMin:5*60*1000,divideUrl:"//api-gemini.jd."+domain+"/abtest/unifyDivide",precision:1000,clogName:"abtest",clogPVType:"100001",clogCType:"100002",clogServerUrl:"//mercury.jd.com/log.gif",logM:"UA-J2011-1",handling:"handling",handled:"handled",instanceType_task:"task"};var utils=function(){return{log:function(msg){if(debugMode){if(typeof window.console!="undefined"){console.log(msg)}}},setItem:function(key,value,storage){if(storage){value=escape(value);this.log("放入sessionStorage：");this.log(value);storage.setItem(key,value)}else{this.log("放入cookie");this.setCookie(key,value)}},getItem:function(key,storage){if(storage){var value=storage.getItem(key);return unescape(value)}else{this.log("sessionStorage不可用，使用cookie");return this.getCookie(key)}},getNowTime:function(){var myDate=new Date();return myDate.getTime()},getUrlParam:function(val,tid){var uri=window.location.search;var paramKey=val+"_"+tid;var reRule=""+paramKey+"=(.+)";var re=new RegExp(reRule,"ig");var result=uri.match(re);if(result){return decodeURI(result[0].substr(paramKey.length+1))}return""},isNodeChild:function(node,target){var isIn=false;if(node==null){return false}if(node==target){return true}if(node.hasChildNodes()){var children=node.children;var child;for(var i=0,len=children.length;i<len;i++){child=children[i];isIn=this.isNodeChild(child,target);if(isIn){return true}}}return false},startWith:function(str,startWith){if(startWith==null||startWith==""||str.length==0||startWith.length>str.length){return false}if(str.substr(0,startWith.length)==startWith){return true}return false},setCookie:function(key,value){this.log("this is setCookie");var exp=new Date();exp.setTime(exp.getTime()+geminiConstant.expiredFiveMin);document.cookie=key+"="+escape(value)+";expires="+exp.toGMTString()+";path=/;domain=.jd."+domain},getCookie:function(key){var arrstr=document.cookie.split("; ");for(var i=0;i<arrstr.length;i++){var temp=arrstr[i].split("=");if(temp[0]==key){return(unescape(temp[1]))}}return""},appendCss:function(name,cssContent){var style=document.createElement("style");style.setAttribute("name",name);style.setAttribute("type","text/css");if(style.styleSheet){style.styleSheet.cssText=cssContent}else{style.appendChild(document.createTextNode(cssContent))}document.getElementsByTagName("head")[0].appendChild(style)},isNoneOrEmpty:function(str){if(typeof str=="undefined"||str==null||str==""||str=="null"){return true}return false},isTrue:function(str){if(typeof str!="undefined"&&(str=="true"||str==true)){return true}return false},isNotTrue:function(str){return !this.isTrue(str)},appendScript:function(name,url){var script=document.createElement("script");script.setAttribute("name",name);script.setAttribute("type","text/javascript");script.setAttribute("charset","utf-8");script.setAttribute("src",url);document.getElementsByTagName("head")[0].appendChild(script)},appendImg:function(name,url){var script=document.createElement("img");script.setAttribute("name",name);script.setAttribute("src",url);script.setAttribute("style","display:none");document.getElementsByTagName("head")[0].appendChild(script)},isNormalDivide:function(abInstance){if(utils.isNoneOrEmpty(abInstance)){return false}return geminiConstant.divideTypeNormal==abInstance.divide},isLocalDivide:function(abInstance){if(utils.isNoneOrEmpty(abInstance)){return false}return geminiConstant.divideTypeLocal==abInstance.divide},isQueryDivide:function(abInstance){if(utils.isNoneOrEmpty(abInstance)){return false}return geminiConstant.divideTypeQuery==abInstance.divide},isDirectionalTask:function(abInstance){return geminiConstant.instanceType_task==abInstance.type},isHandled:function(abInstance){if(typeof abInstance=="undefined"){return false}return geminiConstant.handled==abInstance.handleState},isHandling:function(abInstance){if(typeof abInstance=="undefined"){return false}return geminiConstant.handling==abInstance.handleState},setHandled:function(abInstance){if(typeof abInstance!="undefined"){return abInstance.handleState=geminiConstant.handled}},setHandling:function(abInstance){if(typeof abInstance!="undefined"){return abInstance.handleState=geminiConstant.handling}}}}();var dot=function(){var log=function(v1,v2,args){var arg="";if(args.length>=1){for(var i=0;i<args.length;i++){arg=arg+"|||"+args[i]}arg=arg.substr(3)}else{arg=args[0]}utils.log("log:"+v1+" ,logType:"+v2+"arg:"+arg);requestNewLog(v1,v2,arg)};var customLog=function(clogName,clogCType,logParam){utils.log("customLog打点参数名称:"+clogName+" 类型:"+clogCType+" id:"+logParam[0]+" label:"+logParam[1]+" 用户自定义参数:"+logParam[2]);log(clogName,clogCType,logParam)};var getCustomClick=function(divideObject){return{id:divideObject.id,label:divideObject.label,customClickLog:function(userParam){utils.log("customClickLog:记录用户自定义一次点击："+divideObject.label);var logParam=new Array();logParam.push(divideObject.id);logParam.push(divideObject.label);if(typeof userParam!="undefined"&&userParam!=null){if(userParam.length>32){userParam=userParam.substring(0,32)}logParam.push(userParam)}customLog(geminiConstant.clogName,geminiConstant.clogCType,logParam)}}};var requestNewLog=function(v1,v2,arg){var cul=document.location.href;var ref=document.referrer;var pin=utils.getCookie("pin");var jda=utils.getCookie("__jda");var sid,uid;if(null!=jda&&jda.length>0){var jdaArray=jda.split(".");if(jdaArray.length>0){sid=jdaArray[1]+"|"+jdaArray[5];uid=jdaArray[1]}}var _url=geminiConstant.clogServerUrl;_url+="?t="+v1+"."+v2;_url+="&m="+geminiConstant.logM;_url+="&pin="+encodeURIComponent(pin);if(undefined==sid){_url+="&sid="}else{_url+="&sid="+sid}if(undefined==uid){_url+="&uid="}else{_url+="&uid="+uid}_url+="&cul="+encodeURIComponent(cul);_url+="&ref="+encodeURIComponent(ref);_url+="&v="+encodeURIComponent(arg);_url+="&rm="+new Date().getTime();try{utils.appendImg("gemini_new_log_img",_url)}catch(e1){}};var addListener=function(ele,clickCallback){utils.log("addListener, ele: ");utils.log(ele);if(ele.addEventListener){ele.addEventListener("click",clickCallback,false)}else{if(ele.attachEvent){ele.attachEvent("onclick",clickCallback)}else{ele.onclick=clickCallback}}};var clickLog=function(divideObject){utils.log("记录一次点击："+divideObject.label);var logParam=new Array();logParam.push(divideObject.id);logParam.push(divideObject.label);log(geminiConstant.clogName,geminiConstant.clogCType,logParam)};var addListenerQueue=function(ifram,divideResult){setTimeout(function(){try{if(document.domain!=ifram.contentWindow.document.domain){return}addListener(ifram.contentWindow.document,function(evt){evt=evt||window.event;var target=(typeof evt.target!="undefined")?evt.target:evt.srcElement;clickCallback(target,divideResult,ifram)})}catch(e){utils.log("addListenerQueue： 监听iframe失败,iframe:"+ifram.src+",e:"+e);utils.log("addListenerQueue: exception stack:"+e.stack)}},500)};var innerAddIframeListener=function(ifram,divideResult){if(utils.isNoneOrEmpty(ifram.getAttribute("src"))){return}addListenerQueue(ifram,divideResult)};var initIframeListener=function(divideResult){var iframeArray=document.getElementsByTagName("iframe");for(var i=0;i<iframeArray.length;i++){innerAddIframeListener(iframeArray[i],divideResult)}};var getLabelClass=function(divideResult){return"_"+divideResult.label+"_"+divideResult.id};var clickCallback=function(target,divideResult,ifram){var abInstance=instanceArray[divideResult.id];if(typeof abInstance["customDot"]!="undefined"){utils.log("调用实验"+divideResult.id+",自定义打点方法。");var customClick=getCustomClick(divideResult);abInstance["customDot"](customClick,target);return}if(typeof abInstance["dotZone"]!="undefined"){var dotZone=abInstance["dotZone"];for(var i=0;i<dotZone.length;i++){if(utils.isNoneOrEmpty(dotZone[i])){continue}if(isInListenZone(target,dotZone[i])){clickLog(divideResult);break}}return}if(geminiConstant.dotTypeWhole==abInstance.dot){clickLog(divideResult);return}if(geminiConstant.dotTypeTestZone==abInstance.dot){if(typeof ifram!="undefined"){if(isInListenZone(ifram,getLabelClass(divideResult))){clickLog(divideResult)}}else{if(isInListenZone(target,getLabelClass(divideResult))){clickLog(divideResult)}}return}};var isInListenZone=function(ele,listenClass){if(utils.isNoneOrEmpty(ele)){return false}var currentClass=ele.className;var re=new RegExp("\\b"+listenClass+"\\b");if(!utils.isNoneOrEmpty(currentClass)&&currentClass.length>=listenClass.length&&re.test(currentClass)){return true}if(ele.tagName=="BODY"||ele.tagName=="body"||ele.tagName=="HTML"||ele.tagName=="html"){return false}return isInListenZone(ele.parentNode,listenClass)};var initListener=function(divideResult){addListener(document,function(evt){evt=evt||window.event;var target=(typeof evt.target!="undefined")?evt.target:evt.srcElement;clickCallback(target,divideResult)})};var dotPv=function(divideResult){utils.log("记录一次PV");var logParam=new Array();logParam.push(divideResult.id);logParam.push(divideResult.label);log(geminiConstant.clogName,geminiConstant.clogPVType,logParam)};return{initListenerAndDot:function(divideResult){var abInstance=instanceArray[divideResult.id];if(abInstance.dot==geminiConstant.dotTypeTestZone||abInstance.dot==geminiConstant.dotTypeWhole){dotPv(divideResult);initListener(divideResult);initIframeListener(divideResult)}},addIframeListener:function(ifram,abInstance){if(typeof abInstance=="undefined"){return false}var divideResult=abInstance.divideResult;if(typeof divideResult=="undefined"||utils.isNotTrue(divideResult.tdo)){return false}innerAddIframeListener(ifram,divideResult)}}}();var divide=function(){var forceDivide=function(){var saveForceCache=function(id,urlParam){var label,other,params,tmp,divideCallback;if(typeof urlParam=="undefined"||urlParam==""){return false}params=urlParam.split("&");for(var i=0;i<params.length;i++){if((tmp=params[i].split("="))[0]=="l"){label=tmp[1]}if((tmp=params[i].split("="))[0]=="o"){other=tmp[1]}if((tmp=params[i].split("="))[0]=="dc"){divideCallback=tmp[1]}}var testInfo="{"+'"id":"'+id+'",'+'"tdo":true,'+'"label":"'+label+'",'+'"other":'+other+","+'"divideCallback":"'+divideCallback+'",'+"}";testInfo=eval("("+testInfo+")");divide.setCache(testInfo);utils.log("saveForceCache:强制命中分流");return true};return{checkForceDivide:function(abInstance){var urlParam=utils.getUrlParam(geminiConstant.forceDivideParamKey,abInstance.id);if(urlParam!=""&&urlParam!=null){saveForceCache(abInstance.id,urlParam);return true}return false}}}();var sessionCache=function(){var storage=window.sessionStorage;return{isCacheValid:function(key){var cache=utils.getItem(key,storage);if(!utils.isNoneOrEmpty(cache)){utils.log("sessionCache:实验"+key+"有缓存,直接分流");utils.log("sessionCache"+cache);cache=eval("("+cache+")");var time=cache.time;if((utils.getNowTime()-time)<geminiConstant.expiredFiveMin){return cache[geminiConstant.cacheInfoKey]}utils.log("sessionCache缓存已过期");return null}return null},setCache:function(divideResult,divideCallback){var otherArray=divideResult.other;if(otherArray==null){otherArray=new Array()}var other="[";for(var j=0;j<otherArray.length;j++){other+="'"+otherArray[j]+"',"}if(other!="["){other=other.substring(0,other.length-1)}other+="]";var testInfo="{"+"'id':'"+divideResult.id+"',"+"'tdo':"+divideResult.tdo+","+"'label':'"+divideResult.label+"',"+"'other':"+other+","+"'divideCallback':'"+divideCallback+"'"+"}";var cacheInfo="{"+geminiConstant.cacheInfoKey+":"+testInfo+",time:"+utils.getNowTime()+"}";utils.setItem(geminiConstant.cacheKey+divideResult.id,cacheInfo,storage)}}}();var localCache=function(){var storage=window.localStorage;return{isCacheValid:function(key,abInstance){var cache=utils.getItem(key,storage);if(!utils.isNoneOrEmpty(cache)){utils.log("localCache:实验"+key+"有缓存,直接分流");utils.log("localCache:"+cache);cache=eval("("+cache+")");var cTime=cache.cTime;if(cTime==abInstance.cTime){return cache[geminiConstant.cacheInfoKey]}utils.log("localCache,缓存已过期");return null}return null},setCache:function(divideResult,divideCallback){var otherArray=divideResult.other;if(otherArray==null){otherArray=new Array()}var other="[";for(var j=0;j<otherArray.length;j++){other+="'"+otherArray[j]+"',"}if(other!="["){other=other.substring(0,other.length-1)}other+="]";var testInfo="{"+"'id':'"+divideResult.id+"',"+"'tdo':"+divideResult.tdo+","+"'label':'"+divideResult.label+"',"+"'other':"+other+","+"'divideCallback':'"+divideCallback+"'"+"}";var abInstance=instanceArray[divideResult.id];var cacheInfo="{"+geminiConstant.cacheInfoKey+":"+testInfo+",cTime:"+abInstance.cTime+"}";utils.setItem(geminiConstant.cacheKey+divideResult.id,cacheInfo,storage)}}}();var getCache=function(abInstance){if(abInstance.divide==geminiConstant.divideTypeNormal||abInstance.divide==geminiConstant.divideTypeQuery){return sessionCache.isCacheValid(geminiConstant.cacheKey+abInstance.id)}if(abInstance.divide==geminiConstant.divideTypeLocal){return localCache.isCacheValid(geminiConstant.cacheKey+abInstance.id,abInstance)}};var setCache=function(divideResult,abInstance){if(abInstance.divide==geminiConstant.divideTypeNormal||abInstance.divide==geminiConstant.divideTypeQuery){return sessionCache.setCache(divideResult,abInstance.divideCallback)}if(abInstance.divide==geminiConstant.divideTypeLocal){return localCache.setCache(divideResult,abInstance.divideCallback)}};var randomDivide=function(members){var rateTotal=0;for(var i=0;i<members.length;i++){var member=members[i];rateTotal+=member.rate*geminiConstant.precision;if(i==0){member.min=0}else{member.min=members[i-1].max+1}member.max=member.min+member.rate*geminiConstant.precision-1;if(member.max>geminiConstant.precision-1){utils.log("超出最大范围！"+geminiConstant.precision-1+":"+member.max);return null}}if(rateTotal!=1000){utils.log("分流比率总和不为100%！");return null}var seedOr=Math.random();var seed=parseInt(geminiConstant.precision*seedOr);for(var i=0;i<members.length;i++){var member=members[i];if(member.min<=seed&&seed<=member.max){return member}else{if(i==members.length-1){utils.log("未命中任何比率范围 seed: "+seed+"seedOr: "+seedOr);return null}}}};var getDivideInfoCss=function(divideResult){if(typeof divideResult=="undefined"){return""}var abInstance=instanceArray[divideResult.id];var blockType="block";if(geminiConstant.blockTypeInline==abInstance.blockType){blockType="inline"}var infoCss="."+divideResult.label+"_"+divideResult.id+"{display:"+blockType+" !important;}  ";var otherCss=" ";if(typeof divideResult.other!="undefined"&&divideResult.other.length!=0){var other=divideResult.other;for(var i=0;i<other.length;i++){otherCss+="."+other[i]+"_"+divideResult.id+","}otherCss=otherCss.substring(0,otherCss.length-1);otherCss+="{display:none !important;}"}return infoCss+otherCss};var getDivideInfoCss2=function(divideResult){if(typeof divideResult=="undefined"){return""}var abInstance=instanceArray[divideResult.id];var blockType="block";if(geminiConstant.blockTypeInline==abInstance.blockType){blockType="inline"}var infoCss="._"+divideResult.label+"_"+divideResult.id+"{display:"+blockType+" !important;}  ";var otherCss=" ";if(typeof divideResult.other!="undefined"&&divideResult.other.length!=0){var other=divideResult.other;for(var i=0;i<other.length;i++){otherCss+="._"+other[i]+"_"+divideResult.id+","}otherCss=otherCss.substring(0,otherCss.length-1);otherCss+="{display:none !important;}"}return infoCss+otherCss};var appendCss=function(divideResult){var divideCss=getDivideInfoCss(divideResult);utils.appendCss("gemini_divide_append_css",divideCss);divideCss=getDivideInfoCss2(divideResult);utils.appendCss("gemini_divide_append_css",divideCss)};var pageJump=function(divideResult){if(divideResult.label==""){return}var currentHref=window.location.href;var jumpHref=divideResult.label;var urlParams="";if(currentHref.indexOf("?")>0){urlParams=currentHref.substr(currentHref.indexOf("?")+1)}utils.log("urlParams:"+urlParams);utils.log("pageJump:"+utils.startWith(currentHref,jumpHref));if(!utils.startWith(currentHref,jumpHref)){if(urlParams!=""){if(jumpHref.indexOf("?")>0){jumpHref=jumpHref+"&"+urlParams}else{jumpHref=jumpHref+"?"+urlParams}}utils.log("end jumpHref:"+jumpHref);window.location.href=jumpHref}};var innerDoDivide=function(divideResult){var abInstance=instanceArray[divideResult.id];try{if(typeof abInstance=="undefined"){return}if(utils.isTrue(divideResult.tdo)){if(geminiConstant.divideCallbackCss==abInstance.divideCallback){appendCss(divideResult)}if(geminiConstant.divideCallbackJump==abInstance.divideCallback){pageJump(divideResult)}dot.initListenerAndDot(divideResult)}abInstance.divideResult=divideResult}catch(e){utils.log("innerDoDivide出错了，e:"+e)}finally{utils.setHandled(abInstance)}};var remoteRequest=function(remoteRequestArray){if(remoteRequestArray.length<1){return}var d="",q="";var abInstance;for(var i=0;i<remoteRequestArray.length;i++){abInstance=remoteRequestArray[i];if(utils.isQueryDivide(abInstance)){if(utils.isDirectionalTask(abInstance)){q=q+"{id:'"+abInstance.id+"',type:'task'},"}else{q=q+"{id:'"+abInstance.id+"',type:'ab'},"}}if(utils.isNormalDivide(abInstance)){d=d+"'"+abInstance.id+"',"}}if(q!=""){q=q.substring(0,q.length-1)}if(d!=""){d=d.substring(0,d.length-1)}var param="{d:["+d+"],q:["+q+"]}";var url=geminiConstant.divideUrl+"?info="+param+"&jsVersion=gemini";utils.appendScript("gemini_divide_append",url)};var localRequest=function(localRequestArray){var abInstance;var result="";for(var i=0;i<localRequestArray.length;i++){abInstance=localRequestArray[i];var testId=abInstance.id;var versions=abInstance.label;var testEndTime=parseInt(abInstance.ed);var testStartTime=parseInt(abInstance.st);if(utils.getNowTime()<testStartTime){utils.log("localRequest:实验"+testId+"未开始");continue}var members=new Array();for(var j=0;j<versions.length;j++){var member=versions[j];var memberNew={name:member[0],rate:member[1]};members[j]=memberNew}var selectVersion=randomDivide(members);utils.log("localRequest:命中版本:"+selectVersion.name);var result="{'id':'"+testId+"','tdo':true,'msg':'localDivide','label':'"+selectVersion.name+"',"+"et:"+testEndTime+",'other':[";for(var k=0;k<versions.length;k++){var member=versions[k];if(member[0]==selectVersion.name){continue}result+="'"+member[0]+"',"}if(versions.length>1){result=result.substring(0,result.length-1)}result+="]";result+="}";result=eval("("+result+")");setCache(result,abInstance);innerDoDivide(result)}innerReCheck("localRequest")};var innerReCheck=function(name){var no_handled=0;utils.log(name+",instanceArray："+instanceArray);for(var key in instanceArray){var abInstance=instanceArray[key];if(utils.isNoneOrEmpty(abInstance)){continue}if(utils.isHandled(abInstance)){continue}if(utils.isHandling(abInstance)){continue}no_handled++}utils.log("当前recheckCount："+recheckCount+",no_handled："+no_handled);if(no_handled>0&&(recheckCount--)>0){divide.start()}};return{start:function(){var remoteRequestArray=new Array();var localRequestArray=new Array();var abInstance;for(var key in instanceArray){abInstance=instanceArray[key];try{if(utils.isNoneOrEmpty(abInstance)||utils.isHandled(abInstance)||utils.isHandling(abInstance)){continue}utils.setHandling(abInstance);forceDivide.checkForceDivide(abInstance);var cache=getCache(abInstance);if(cache!=null){innerDoDivide(cache);continue}if(utils.isLocalDivide(abInstance)){localRequestArray.push(abInstance)}if(utils.isNormalDivide(abInstance)||utils.isQueryDivide(abInstance)){remoteRequestArray.push(abInstance)}}catch(e1){utils.log("do abInstance 失败，e:"+e1)}}remoteRequest(remoteRequestArray);localRequest(localRequestArray)},setCache:function(divideResult){setCache(divideResult,instanceArray[divideResult.id])},requestCallback:function(result){for(var i=0;i<result.length;i++){utils.log("requestCallback:"+result[i]);try{if(typeof instanceArray[result[i].id]=="undefined"){continue}setCache(result[i],instanceArray[result[i].id]);innerDoDivide(result[i])}catch(e){utils.log("requestCallback has exception,e:"+e)}}innerReCheck("requestCallback")},reCheck:innerReCheck}}();divide.start();var innerAPI=function(){return{reCheckInstance:function(key,value){if(typeof instanceArray[key]=="undefined"){instanceArray[key]=value;divide.reCheck("reCheckInstance")}},pushNewInstance:function(abInstance){if(typeof instanceArray[abInstance.id]=="undefined"){instanceArray[abInstance.id]=abInstance;divide.reCheck("pushNewInstance")}},addListenerForIframe:function(testId,ifram){dot.addIframeListener(ifram,instanceArray[testId])},getDivideResult:function(testId){var abInstance=instanceArray[testId];if(typeof abInstance!="undefined"){return abInstance.divideResult}return null}}}();return{requestCallback:function(result){try{if(utils.isNoneOrEmpty(result)){return}result=eval("("+result+")");divide.requestCallback(result)}catch(e){utils.log("requestCallback had exception,e:"+e);utils.log("exception stack : "+e.stack)}},api:innerAPI}}();
